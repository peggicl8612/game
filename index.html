<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ä¼Šå¡å“‡çŒœçŒœæ¨‚ âœ¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #FFD1DC; --y: #FFF9E5; --b: #E0F7FA; --t: #5A5A5A; }
        body { background: var(--y); font-family: "Microsoft JhengHei", sans-serif; color: var(--t); text-align: center; margin: 0; padding: 15px; }
        .card { background: white; border: 4px solid var(--t); border-radius: 25px; padding: 20px; max-width: 400px; margin: auto; box-shadow: 8px 8px 0 var(--p); }
        .q-img { width: 100%; border-radius: 15px; border: 3px solid var(--t); margin: 15px 0; display: block; }
        input { width: 85%; padding: 12px; border-radius: 15px; border: 2px solid var(--t); margin-bottom: 10px; font-size: 16px; outline: none; }
        .btn { background: var(--p); border: 3px solid var(--t); padding: 12px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn:active { transform: translateY(3px); }
        .timer { font-size: 2rem; font-weight: bold; color: #FF8E9E; }
        #qrcode img { margin: auto; border: 5px solid white; border-radius: 10px; }
        .podium { display: flex; justify-content: space-around; align-items: flex-end; height: 160px; margin: 20px 0; }
        .place { background: var(--p); border: 3px solid var(--t); width: 80px; border-radius: 10px 10px 0 0; padding: 10px 5px; font-weight: bold; }
        .p-1 { height: 110px; background: #FFD700; } .p-2 { height: 80px; background: #C0C0C0; } .p-3 { height: 60px; background: #CD7F32; }

        /* è¼‰å…¥å‹•ç•« */
        .loading-animation { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; }
        .loading-animation img { width: 80px; height: 80px; animation: bounce 1s infinite alternate; }
        .loading-animation p { margin-top: 15px; font-weight: bold; color: #777; }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-15px); }
        }

        .loading-img {
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="card">
        <div id="login-zone">
            <h2>ğŸ€ é‚€è«‹æœ‹å‹åŠ å…¥</h2>
            <div id="qrcode" style="margin-bottom: 15px;"></div>
            <p style="font-size: 0.9rem; color: #888;">æƒæä¸Šæ–¹ QR Code åŠ å…¥éŠæˆ²</p>
            <input type="text" id="nickname" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±...">
            <button class="btn" id="join-btn">åŠ å…¥ä¸¦ç­‰å¾…é–‹å§‹</button>
        </div>

        <div id="waiting-zone" style="display:none;">
            <div class="loading-animation">
                <img class="loading-img" src="https://www.jins.com/tw/upload/2025/12/25/compress-694c9d6d1cf0b.jpg" alt="Chiikawa Loading">  
                <p>ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²ä¸­... âœ¨</p>
            </div>
        </div>

        <div id="game-zone" style="display:none;">
            <div id="timer" class="timer">15</div>
            <img id="q-img" class="q-img">
            <div id="answer-box">
                <input type="text" id="ans-input" placeholder="ç­”æ¡ˆæ˜¯ï¼Ÿ">
                <button class="btn" id="submit-btn">é€å‡ºç­”æ¡ˆ</button>
            </div>
            <p id="wait-msg" style="display:none;">å·²é€å‡ºï¼Œç­‰å¾…ä¸‹ä¸€é¡Œ... ğŸµ</p>
        </div>

        <div id="rank-zone" style="display:none;">
            <h3>âœ¨ ç›®å‰ç©åˆ†æ’å</h3>
            <div id="rank-list"></div>
        </div>

        <div id="ceremony-zone" style="display:none;">
            <h2>ğŸ† é ’çå…¸ç¦® ğŸ†</h2>
            <div class="podium" id="podium-content"></div>
            <div id="final-list"></div>
            <button class="btn" style="margin-top:20px" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBEkuEJ19FQ-0y-KiJeInCUZ7BTv6TuXOE",
            authDomain: "game-3dc74.firebaseapp.com",
            databaseURL: "https://game-3dc74-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "game-3dc74",
            storageBucket: "game-3dc74.firebasestorage.app",
            messagingSenderId: "239384658458",
            appId: "1:239384658458:web:3986833e5d61fc932a87a3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // åˆå§‹åŒ– QR Code
        window.onload = () => {
            if (typeof QRCode !== "undefined") {
                new QRCode(document.getElementById("qrcode"), {
                    text: window.location.href,
                    width: 140,
                    height: 140
                });
            }
        };

        let myName = "";
        let questions = [];

        document.getElementById('join-btn').onclick = () => {
            myName = document.getElementById('nickname').value;
            if(!myName) return alert("è«‹è¼¸å…¥æš±ç¨±ï¼");
            
            // å¯«å…¥ç©å®¶åˆ°è³‡æ–™åº«
            set(ref(db, `users/${myName}`), { score: 0, lastAns: "", lastTime: 0 });
            
            // éš±è—ç™»å…¥å€ï¼Œé¡¯ç¤ºç­‰å¾…å€
            document.getElementById('login-zone').style.display = 'none';
            document.getElementById('waiting-zone').style.display = 'block';
            
            listenToGame();
        };

        document.getElementById('submit-btn').onclick = () => {
            const ans = document.getElementById('ans-input').value;
            onValue(ref(db, 'gameState/startTime'), (snap) => {
                update(ref(db, `users/${myName}`), { 
                    lastAns: ans, 
                    lastTime: Date.now() - snap.val() 
                });
            }, {onlyOnce: true});
            document.getElementById('answer-box').style.display = 'none';
            document.getElementById('wait-msg').style.display = 'block';
        };

        function listenToGame() {
            onValue(ref(db, 'gameData/questions'), snap => { questions = snap.val(); });

            onValue(ref(db, 'gameState'), snap => {
                const state = snap.val();
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæ²’æœ‰ç‹€æ…‹ï¼Œå°±å¼·åˆ¶åœç•™åœ¨ç­‰å¾…ç•«é¢
                if (!state || !state.status || state.status === "null") { // å¢åŠ  null åˆ¤æ–·
                    hideAllGameZones();
                    document.getElementById('waiting-zone').style.display = 'block';
                    return;
                }

                // éš±è—ç­‰å¾…å€ (ä¸€æ—¦æ”¶åˆ°æœ‰æ•ˆç‹€æ…‹å°±éš±è—)
                document.getElementById('waiting-zone').style.display = 'none';

                if(state.status === "playing") {
                    showQuestion(state);
                } else if(state.status === "round_rank") {
                    showRanking("rank-zone", "rank-list");
                } else if(state.status === "final_ceremony") {
                    showFinalCeremony(); 
                }
            });
        }

        function hideAllGameZones() {
            document.getElementById('login-zone').style.display = 'none';
            document.getElementById('waiting-zone').style.display = 'none';
            document.getElementById('game-zone').style.display = 'none';
            document.getElementById('rank-zone').style.display = 'none';
            document.getElementById('ceremony-zone').style.display = 'none';
        }

        function showQuestion(state) {
            hideAllGameZones();
            document.getElementById('game-zone').style.display = 'block';
            
            document.getElementById('answer-box').style.display = 'block';
            document.getElementById('wait-msg').style.display = 'none';
            document.getElementById('ans-input').value = "";
            
            const qImg = document.getElementById('q-img');
            if (questions && questions[state.index]) {
                qImg.src = questions[state.index].img;
                qImg.style.display = 'block';
            } else {
                // å¦‚æœé¡Œç›®é‚„æ²’è¼‰å…¥ï¼Œé¡¯ç¤ºè¼‰å…¥æç¤º
                qImg.style.display = 'none';
                document.getElementById('game-zone').innerHTML += "<p>è¼‰å…¥é¡Œç›®ä¸­...</p>";
            }

            let timerItv = setInterval(() => {
                const remain = 15 - Math.floor((Date.now() - state.startTime) / 1000);
                document.getElementById('timer').innerText = Math.max(0, remain);
                if(remain <= 0) clearInterval(timerItv);
            }, 1000);
        }

        function showRanking(zoneId, listId) {
            hideAllGameZones();
            document.getElementById(zoneId).style.display = 'block';
            onValue(ref(db, 'users'), snap => {
                const data = snap.val();
                if(!data) return;
                const users = Object.entries(data).sort((a,b) => b[1].score - a[1].score);
                document.getElementById(listId).innerHTML = users.map((u, i) => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px dashed #ccc;">
                        <span>${i+1}. ${u[0]}</span><span>${u[1].score} åˆ†</span>
                    </div>`
                ).join('');
            }, {onlyOnce: true});
        }

        function showFinalCeremony() {
            hideAllGameZones();
            document.getElementById('ceremony-zone').style.display = 'block';
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

            onValue(ref(db, 'users'), snap => {
                const data = snap.val();
                if(!data) return;
                const users = Object.entries(data).sort((a,b) => b[1].score - a[1].score);
                
                const podium = document.getElementById('podium-content');
                podium.innerHTML = `
                    <div class="place p-2">ğŸ¥ˆ<br>${users[1]?.[0] || '-'}</div>
                    <div class="place p-1">ğŸ¥‡<br>${users[0]?.[0] || '-'}</div>
                    <div class="place p-3">ğŸ¥‰<br>${users[2]?.[0] || '-'}</div>
                `;

                document.getElementById('final-list').innerHTML = users.map((u, i) => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px dashed #ccc;">
                        <span>${i+1}. ${u[0]}</span><span>${u[1].score} åˆ†</span>
                    </div>`
                ).join('');
            }, {onlyOnce: true});
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‰ä¼Šå¡å“‡æ§å ´å¤§å¸« ğŸ‘‘</title>
    <style>
        :root { --p: #FFD1DC; --b: #E0F7FA; --y: #FFF9E5; --t: #5A5A5A; }
        body { background: var(--b); font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 20px; color: var(--t); }
        .admin-box { background: white; border: 4px solid var(--t); border-radius: 20px; padding: 20px; max-width: 600px; margin: auto; box-shadow: 8px 8px 0 var(--p); }
        .setup-header { display: flex; justify-content: space-between; align-items: center; background: var(--y); padding: 10px 15px; border-radius: 15px; border: 2px solid var(--t); margin-bottom: 20px; }
        .player-count { font-size: 1.1rem; color: #FF8E9E; font-weight: bold; }
        #questions-list { max-height: 350px; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        .q-item { background: #fff; border: 2px dashed var(--p); padding: 15px; margin-bottom: 10px; border-radius: 12px; }
        input { width: 90%; padding: 10px; margin: 5px 0; border: 2px solid var(--t); border-radius: 8px; }
        .btn { padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; border: 2px solid var(--t); margin: 5px; }
        .btn-reset { background: #FFAB91; color: white; }
        .btn-add { background: #B2DFDB; }
        .btn-start { background: var(--p); font-size: 1.2rem; width: 100%; margin-top: 10px; box-shadow: 0 4px 0 #e8a7b6; }
        .status-msg { margin-top: 10px; font-weight: bold; color: #5A5A5A; min-height: 24px; }
    </style>
</head>
<body>

    <div class="admin-box">
        <h2>ğŸ‘‘ ä¸»æŒäººæ§åˆ¶é¢ç‰ˆ</h2>
        
        <div class="setup-header">
            <div class="player-count">ğŸ® å·²åŠ å…¥äººæ•¸ï¼š<span id="p-count">0</span></div>
            <button class="btn btn-reset" onclick="resetGame()">ğŸ§¹ æ¸…ç©ºé‡è¨­</button>
        </div>

        <div id="questions-list">
            <div class="q-item">
                <strong>ç¬¬ 1 é¡Œ</strong>
                <input type="text" class="q-img" placeholder="åœ–ç‰‡é€£çµ (URL)">
                <input type="text" class="q-ans" placeholder="æ­£ç¢ºç­”æ¡ˆ (å¤šå€‹ç”¨é€—è™Ÿéš”é–‹)">
            </div>
        </div>

        <button class="btn btn-add" onclick="addQuestion()">â• æ–°å¢ä¸€é¡Œ</button>
        <div id="current-status" class="status-msg">ç­‰å¾…è¨­å®šä¸­...</div>
        <button class="btn btn-start" onclick="startAutoGame()">ğŸš€ é–‹å§‹åŒæ­¥éŠæˆ²</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Firebase è¨­å®š (è«‹ç¢ºä¿èˆ‡ç©å®¶ç«¯ä¸€è‡´)
        const firebaseConfig = {
            apiKey: "AIzaSyBEkuEJ19FQ-0y-KiJeInCUZ7BTv6TuXOE",
            authDomain: "game-3dc74.firebaseapp.com",
            databaseURL: "https://game-3dc74-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "game-3dc74",
            storageBucket: "game-3dc74.firebasestorage.app",
            messagingSenderId: "239384658458",
            appId: "1:239384658458:web:3986833e5d61fc932a87a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ç›£è½äººæ•¸
        onValue(ref(db, 'users'), (snap) => {
            const count = snap.exists() ? Object.keys(snap.val()).length : 0;
            document.getElementById('p-count').innerText = count;
        });

        // ğŸ§¹ å¾¹åº•é‡è¨­åŠŸèƒ½ï¼šé€™æ˜¯è®“ç©å®¶ç«¯ã€Œä¸ç•™ç™½ã€çš„é—œéµ
        window.resetGame = async () => {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºè³‡æ–™åº«å—ï¼Ÿç©å®¶ç«¯å°‡å›åˆ°åˆå§‹ç­‰å¾…ç‹€æ…‹ã€‚")) {
                await set(ref(db, '/'), { users: null, gameState: null, gameData: null });
                alert("è³‡æ–™åº«å·²æ­¸é›¶ï¼");
                location.reload();
            }
        };

        window.addQuestion = () => {
            const list = document.getElementById('questions-list');
            const num = document.querySelectorAll('.q-item').length + 1;
            const div = document.createElement('div');
            div.className = 'q-item';
            div.innerHTML = `<strong>ç¬¬ ${num} é¡Œ</strong><input type="text" class="q-img" placeholder="åœ–ç‰‡é€£çµ"><input type="text" class="q-ans" placeholder="æ­£ç¢ºç­”æ¡ˆ">`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        };

        // ğŸš€ å•Ÿå‹•æµç¨‹
        window.startAutoGame = async () => {
            const imgs = document.querySelectorAll('.q-img');
            const ans = document.querySelectorAll('.q-ans');
            const questions = [];

            imgs.forEach((el, i) => {
                if(el.value.trim() && ans[i].value.trim()) {
                    questions.push({
                        img: el.value.trim(),
                        ans: ans[i].value.split(',').map(s => s.trim())
                    });
                }
            });

            if(questions.length === 0) return alert("è«‹å…ˆè¼¸å…¥é¡Œç›®å…§å®¹ï¼");

            const statusMsg = document.getElementById('current-status');
            
            // 1. å…ˆæŠŠ gameState è¨­ç‚º nullï¼Œå¼·åˆ¶è®“ç©å®¶ç«¯é€²å…¥ç­‰å¾…é‚è¼¯
            await remove(ref(db, 'gameState'));
            
            // 2. å­˜å…¥é¡Œåº«ä¸¦é‡ç½®åˆ†æ•¸
            await set(ref(db, 'gameData/questions'), questions);
            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val();
                if(users) {
                    for(let name in users) {
                        update(ref(db, `users/${name}`), { score: 0, lastAns: "", lastTime: 0 });
                    }
                }
            }, {onlyOnce: true});

            // 3. é–‹å§‹å®šæ™‚å¾ªç’°
            let idx = 0;
            const run = () => {
                if(idx < questions.length) {
                    statusMsg.innerText = `ğŸ“¢ æ’­é€ä¸­ï¼šç¬¬ ${idx+1} é¡Œ`;
                    set(ref(db, 'gameState'), {
                        status: "playing",
                        index: idx,
                        startTime: Date.now()
                    });

                    // 15ç§’ç­”é¡Œ
                    setTimeout(() => {
                        calculatePoints(questions[idx].ans);
                        set(ref(db, 'gameState/status'), "round_rank");
                        statusMsg.innerText = `é¡¯ç¤ºç¬¬ ${idx+1} é¡Œæ’å...`;
                        
                        idx++;
                        // 5ç§’æ’åç·©è¡å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
                        setTimeout(run, 5000);
                    }, 15000);
                } else {
                    statusMsg.innerText = "ğŸ† éŠæˆ²çµæŸï¼é ’çä¸­";
                    set(ref(db, 'gameState/status'), "final_ceremony");
                }
            };
            run();
        };

       function calculatePoints(correctArray) {
    onValue(ref(db, 'users'), (snap) => {
        const users = snap.val();
        if (!users) return;

        for (let name in users) {
            const u = users[name];
            
            // æª¢æŸ¥ç©å®¶æ˜¯å¦æœ‰ç­”æ¡ˆä¸”åœ¨æ­£ç¢ºç­”æ¡ˆæ¸…å–®ä¸­
            if (u.lastAns && correctArray.includes(u.lastAns.trim())) {
                
                // è¨ˆç®—å‰©é¤˜ç§’æ•¸ (15 - å·²ç”¨ç§’æ•¸)
                const usedSeconds = Math.floor((u.lastTime || 0) / 1000);
                const remain = 15 - usedSeconds;
                
                let addedScore = 0;

                // æ ¹æ“šä½ æä¾›çš„æ–°åˆ†æ•¸è¦å‰‡é€²è¡Œåˆ¤æ–·
                if (remain >= 14) {
                    addedScore = 999;
                } else if (remain >= 12) {
                    addedScore = 927;
                } else if (remain >= 10) {
                    addedScore = 889;
                } else if (remain >= 8) {
                    addedScore = 831;
                } else if (remain >= 6) {
                    addedScore = 769;
                } else if (remain >= 4) {
                    addedScore = 684;
                } else if (remain >= 2) {
                    addedScore = 599;
                } else {
                    addedScore = 502; // 0-1ç§’
                }

                // æ›´æ–°è³‡æ–™åº«ä¸­çš„åˆ†æ•¸
                update(ref(db, `users/${name}`), { 
                    score: (u.score || 0) + addedScore,
                    lastAns: "" // æ¸…ç©ºç­”æ¡ˆä»¥ä¾¿ä¸‹ä¸€é¡Œ
                });
            } else {
                // æ²’ç­”å°æˆ–æ²’ä½œç­”ï¼Œåƒ…æ¸…ç©ºæœ€å¾Œç­”æ¡ˆ
                update(ref(db, `users/${name}`), { lastAns: "" });
            }
        }
    }, { onlyOnce: true });
}
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‰ä¼Šå¡å“‡æ§å ´å¤§å¸« ğŸ‘‘</title>
    <style>
        :root { --p: #FFD1DC; --b: #E0F7FA; --y: #FFF9E5; --t: #5A5A5A; }
        body { background: var(--b); font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 20px; color: var(--t); }
        .admin-box { background: white; border: 4px solid var(--t); border-radius: 20px; padding: 20px; max-width: 600px; margin: auto; box-shadow: 8px 8px 0 var(--p); }
        .setup-header { display: flex; justify-content: space-between; align-items: center; background: var(--y); padding: 10px 15px; border-radius: 15px; border: 2px solid var(--t); margin-bottom: 20px; }
        #questions-list { max-height: 400px; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        .q-item { background: #fff; border: 2px dashed var(--p); padding: 15px; margin-bottom: 15px; border-radius: 12px; position: relative; }
        .preview-img { width: 100px; height: 100px; object-fit: cover; border: 2px solid var(--t); border-radius: 10px; margin-top: 10px; display: none; }
        input[type="text"], input[type="file"] { width: 90%; padding: 10px; margin: 5px 0; border: 2px solid var(--t); border-radius: 8px; }
        .btn { padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; border: 2px solid var(--t); margin: 5px; }
        .btn-reset { background: #FFAB91; }
        .btn-add { background: #B2DFDB; }
        .btn-start { background: var(--p); font-size: 1.2rem; width: 100%; margin-top: 10px; }
        .status-msg { margin: 10px 0; font-weight: bold; color: #FF8E9E; }
    </style>
</head>
<body>

    <div class="admin-box">
        <h2>ä¸»æŒäººæ§åˆ¶é¢ç‰ˆ</h2>
        
        <div class="setup-header">
            <div>ğŸ® å·²åŠ å…¥ï¼š<span id="p-count">0</span> äºº</div>
            <button class="btn btn-reset" onclick="resetGame()">ğŸ§¹ æ¸…ç©ºé‡è¨­</button>
        </div>

        <div id="questions-list">
            <div class="q-item" id="q-1">
                <strong>ç¬¬ 1 é¡Œ</strong>
                <input type="file" class="q-file" accept="image/*" onchange="previewImage(this)">
                <img class="preview-img">
                <input type="text" class="q-ans" placeholder="è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ">
            </div>
        </div>

        <button class="btn btn-add" onclick="addQuestion()">â• æ–°å¢é¡Œç›®</button>
        <div id="current-status" class="status-msg">ç­‰å¾…é–‹å§‹...</div>
        <button class="btn btn-start" onclick="startAutoGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBEkuEJ19FQ-0y-KiJeInCUZ7BTv6TuXOE",
            authDomain: "game-3dc74.firebaseapp.com",
            databaseURL: "https://game-3dc74-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "game-3dc74",
            storageBucket: "game-3dc74.firebasestorage.app",
            messagingSenderId: "239384658458",
            appId: "1:239384658458:web:3986833e5d61fc932a87a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // äººæ•¸ç›£è½
        onValue(ref(db, 'users'), (snap) => {
            document.getElementById('p-count').innerText = snap.exists() ? Object.keys(snap.val()).length : 0;
        });

        // åœ–ç‰‡é è¦½èˆ‡è½‰æ› Base64
        window.previewImage = (input) => {
            const file = input.files[0];
            const preview = input.parentElement.querySelector('.preview-img');
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        window.addQuestion = () => {
            const list = document.getElementById('questions-list');
            const num = document.querySelectorAll('.q-item').length + 1;
            const div = document.createElement('div');
            div.className = 'q-item';
            div.innerHTML = `
                <strong>ç¬¬ ${num} é¡Œ</strong>
                <input type="file" class="q-file" accept="image/*" onchange="previewImage(this)">
                <img class="preview-img">
                <input type="text" class="q-ans" placeholder="æ­£ç¢ºç­”æ¡ˆ">
            `;
            list.appendChild(div);
        };

        window.resetGame = async () => {
            if(confirm("ç¢ºå®šé‡è¨­ï¼Ÿ")) {
                await set(ref(db, '/'), { users: null, gameState: null, gameData: null });
                location.reload();
            }
        };

        window.startAutoGame = async () => {
            const items = document.querySelectorAll('.q-item');
            const questions = [];

            for (let item of items) {
                const imgData = item.querySelector('.preview-img').src;
                const ansText = item.querySelector('.q-ans').value.trim();
                if (imgData && ansText) {
                    questions.push({
                        img: imgData, // é€™è£¡æ˜¯ base64 å­—ä¸²
                        ans: ansText.split(',').map(s => s.trim())
                    });
                }
            }

            if(questions.length === 0) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ä¸¦è¼¸å…¥ç­”æ¡ˆï¼");

            const statusMsg = document.getElementById('current-status');
            await remove(ref(db, 'gameState'));
            await set(ref(db, 'gameData/questions'), questions);

            // é‡ç½®åˆ†æ•¸
            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val();
                if(users) {
                    for(let name in users) update(ref(db, `users/${name}`), { score: 0, lastAns: "", lastTime: 0 });
                }
            }, {onlyOnce: true});

            let idx = 0;
            const run = () => {
                if(idx < questions.length) {
                    statusMsg.innerText = `ğŸ“¢ ç¬¬ ${idx+1} é¡Œæ’­é€ä¸­...`;
                    set(ref(db, 'gameState'), { status: "playing", index: idx, startTime: Date.now() });

                    setTimeout(() => {
                        calculatePoints(questions[idx].ans);
                        set(ref(db, 'gameState/status'), "round_rank");
                        idx++;
                        setTimeout(run, 5000);
                    }, 15000);
                } else {
                    set(ref(db, 'gameState/status'), "final_ceremony");
                }
            };
            run();
        };

        function calculatePoints(correctArray) {
            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val();
                if(!users) return;
                for(let name in users) {
                    const u = users[name];
                    if(u.lastAns && correctArray.includes(u.lastAns.trim())) {
                        const remain = 15 - Math.floor((u.lastTime || 0)/1000);
                        let added = 0;
                        if (remain >= 14) added = 999;
                        else if (remain >= 12) added = 927;
                        else if (remain >= 10) added = 889;
                        else if (remain >= 8) added = 831;
                        else if (remain >= 6) added = 769;
                        else if (remain >= 4) added = 684;
                        else if (remain >= 2) added = 599;
                        else added = 502;

                        update(ref(db, `users/${name}`), { 
                            score: (u.score || 0) + added,
                            lastAns: ""
                        });
                    } else {
                        update(ref(db, `users/${name}`), { lastAns: "" });
                    }
                }
            }, {onlyOnce: true});
        }
    </script>
</body>
</html>
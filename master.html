<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‰ä¼Šå¡å“‡æ§åˆ¶å° ğŸ‘‘</title>
    <style>
        body { background: #E0F7FA; font-family: sans-serif; text-align: center; padding: 20px; }
        .admin-box { background: white; border: 4px solid #5A5A5A; border-radius: 20px; padding: 20px; max-width: 500px; margin: auto; }
        input { width: 80%; padding: 10px; margin: 10px; border: 2px solid #5A5A5A; border-radius: 10px; }
        .btn { background: #FFD1DC; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; border: 2px solid #5A5A5A; }
    </style>
</head>
<body>
    <div class="admin-box">
        <h2>ğŸ‘‘ ä¸»æŒäººæ§åˆ¶é¢æ¿</h2>
        <input type="text" id="img-url" placeholder="åœ–ç‰‡ URL">
        <input type="text" id="ans" placeholder="æ­£ç¢ºç­”æ¡ˆ (å¤šå€‹ç”¨é€—è™Ÿéš”é–‹)">
        <br>
        <button class="btn" onclick="sendQ()">ğŸš€ ç™¼å¸ƒé¡Œç›® (15ç§’å€’æ•¸)</button>
        <button class="btn" style="background: #E0F7FA;" onclick="endRound()">ğŸ çµæŸé€™ä¸€é¡Œä¸¦æ’å</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
    apiKey: "AIzaSyBEkuEJ19FQ-0y-KiJeInCUZ7BTv6TuXOE",
    authDomain: "game-3dc74.firebaseapp.com",
     databaseURL: "https://game-3dc74-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "game-3dc74",
    storageBucket: "game-3dc74.firebasestorage.app",
    messagingSenderId: "239384658458",
    appId: "1:239384658458:web:3986833e5d61fc932a87a3",
    measurementId: "G-Q0J38297L3"
};
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

     window.sendQ = () => {
    const imgElement = document.getElementById('img-url');
    const ansElement = document.getElementById('ans');
    
    // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…æŠ“ä¸åˆ°å€¼å ±éŒ¯
    if (!imgElement || !ansElement) return;

    const img = imgElement.value;
    const ans = ansElement.value.split(',');

    if (!img || !ansElement.value) {
        alert("è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€èˆ‡ç­”æ¡ˆï¼");
        return;
    }

    // åŸ·è¡Œå¯«å…¥
    set(ref(db, 'gameState'), {
        status: "playing",
        imgUrl: img,
        answers: ans,
        startTime: Date.now()
    }).then(() => {
        alert("é¡Œç›®å·²æˆåŠŸç™¼ä½ˆï¼å€’æ•¸é–‹å§‹ï¼");
    }).catch((error) => {
        console.error("ç™¼ä½ˆå¤±æ•—ï¼š", error);
        alert("ç™¼ä½ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚");
    });
};
     window.endRound = () => {
            // æŠ“å– gameState çš„ç­”æ¡ˆé€²è¡Œæ¯”åˆ†
            onValue(ref(db, 'game'), (snap) => {
                const state = snap.val();
                const correctOnes = state.answers;
                onValue(ref(db, 'users'), (uSnap) => {
                    const users = uSnap.val();
                    for(let name in users) {
                        if(correctOnes.includes(users[name].lastAns)) {
                            // è¨ˆç®—é€Ÿåº¦åŠ åˆ†
                            const bonus = Math.max(0, 15 - Math.floor((users[name].time - state.startTime)/1000));
                            update(ref(db, 'users/' + name), { 
                                score: users[name].score + 100 + (bonus * 10),
                                lastAns: "" 
                            });
                        }
                    }
                }, { onlyOnce: true });
            }, { onlyOnce: true });
            set(ref(db, 'gameState/status'), "ranking");
        };

        // åœ¨åŸæœ¬çš„ master.html è…³æœ¬ä¸­æ›¿æ›æˆ–æ–°å¢æ­¤å‡½æ•¸
window.startAutoGame = () => {
    const totalQuestions = questions.length;
    let qIndex = 0;

    // å®šç¾©æ¯ä¸€è¼ªçš„ç¸½æ™‚é•· (15ç§’ç­”é¡Œ + 5ç§’çœ‹æ’å = 20ç§’)
    const ROUND_DURATION = 20000; 

    const startSession = Date.now();

    function triggerNext() {
        if (qIndex < totalQuestions) {
            set(ref(db, 'gameState'), {
                index: qIndex,
                status: "playing",
                startTime: Date.now(),
                mode: "auto"
            });

            // 15ç§’å¾Œè‡ªå‹•è½‰ç‚ºæ’åæ¨¡å¼
            setTimeout(() => {
                set(ref(db, 'gameState/status'), "round_rank");
            }, 15000);

            qIndex++;
            // 20ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ
            setTimeout(triggerNext, ROUND_DURATION);
        } else {
            // å…¨éƒ¨çµæŸï¼Œé¡¯ç¤ºé ’çå°
            set(ref(db, 'gameState/status'), "final_ceremony");
        }
    }

    triggerNext();
};
    </script>
</body>
</html>